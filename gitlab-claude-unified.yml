# Simplified GitLab CI/CD Configuration using unified entrypoint
# Safe for remote include (strict YAML parsing)

claude_webhook_handler:
  image: oven/bun:slim
  stage: build
  tags:
    - docker

  environment:
    name: claude-code

  before_script:
    # Install required packages (including jq for output processing)
    - apt-get update && apt-get install -y git openssh-client jq

    # Clone Claude Code
    - git clone https://gitlab.tech90.cloud/teknosoft2/gitlab-claude.git /tmp/claude-code
    - cd /tmp/claude-code
    - bun install

    # Configure git identity
    - git config --global user.name "Claude Bot"
    - git config --global user.email "claude-bot@example.com"

    # Configure git credentials
    - git config --global credential.helper store
    - |
      if [ -n "${CLAUDE_CODE_GL_ACCESS_TOKEN}" ]; then
        echo "Configuring git credentials..."
        echo "https://gitlab-ci-token:${CLAUDE_CODE_GL_ACCESS_TOKEN}@${CI_SERVER_HOST}" >> ~/.git-credentials
        chmod 600 ~/.git-credentials
        git remote set-url origin "https://gitlab-ci-token:${CLAUDE_CODE_GL_ACCESS_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git"
      else
        echo "WARNING: CLAUDE_CODE_GL_ACCESS_TOKEN not set"
      fi

    # Return to project directory
    - cd "${CI_PROJECT_DIR}"

  script:
    - echo "Processing GitLab webhook event"
    - echo "Event type: ${GITLAB_EVENT_TYPE}"
    - echo "Project: ${CLAUDE_PROJECT_PATH}"
    - echo "Resource Type: ${CLAUDE_RESOURCE_TYPE}"
    - echo "Resource ID: ${CLAUDE_RESOURCE_ID}"
    - echo "Branch: ${CLAUDE_BRANCH}"
    - echo "Author: ${CLAUDE_AUTHOR}"
    - echo "Note: ${CLAUDE_NOTE}"

    # Run unified entrypoint
    - cd /tmp/claude-code
    - bun run src/entrypoints/gitlab_entrypoint.ts

  rules:
    - if: '$CLAUDE_TRIGGER == "true"'

  variables:
    # IMPORTANT: Authentication variables must be set in GitLab CI/CD Variables
    # Go to: Project Settings → CI/CD → Variables
    # Required variables:
    #   - CLAUDE_CODE_OAUTH_TOKEN: Your Claude Code OAuth token
    #   - CLAUDE_CODE_GL_ACCESS_TOKEN: Your GitLab Personal/Project Access Token (with 'api' scope)
    # These variables will be automatically available to the job and do NOT need to be defined here.

    # IMPORTANT: The following variables are automatically set by the webhook server:
    #   - CLAUDE_BRANCH: The branch Claude should work on (created for issues, source branch for MRs)
    #   - CLAUDE_RESOURCE_TYPE: Either "issue" or "merge_request"
    #   - CLAUDE_RESOURCE_ID: The IID of the issue or MR
    #   - CLAUDE_AUTHOR: Username who triggered Claude
    #   - CLAUDE_NOTE: The comment text that triggered Claude
    # Do NOT manually set these - they come from the webhook.

    # Claude behavior
    CLAUDE_TRIGGER_PHRASE: "@claude"
    CLAUDE_MODEL: "sonnet"

    # Git behavior
    GIT_STRATEGY: "clone"
    GIT_CLEAN_FLAGS: "-fdx"

    # Docker
    DOCKER_DRIVER: "overlay2"